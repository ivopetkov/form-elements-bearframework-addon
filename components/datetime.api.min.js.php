<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='datetime']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("input"),n=e.querySelector('[data-form-element-component="button"]'),r=e.querySelector('[data-form-element-component="picker"]'),o=null!==n,a=null!==r,i=(t.getAttribute("showTime"),"false"!==t.getAttribute("showYear")),l="false"!==t.getAttribute("showClear"),u=-1!==["true",""].indexOf(t.getAttribute("multiple")),m="false"!==t.getAttribute("allowSelect"),d=ivoPetkovBearFrameworkAddonsFormElementsDateTimeFormatDate;o&&n.addEventListener("keydown",(function(e){13===e.keyCode&&n.click()}));var c=function(){var e=t.getAttribute("currentDate");return null!==e?new Date(e):new Date},f=function(e){var t=[];if(null!=e)for(var n=e.split(";"),r=0;r<n.length;r++){var o=n[r].trim();o.length>0&&t.push(o)}return t},s=function(){var e=f(t.value);e.sort().reverse();var n=e.length>0?e[0]:"";i||(n=n.replace("0000-","2024-"));var r=""!==n?new Date(n):c();return i||r.setFullYear(2024),r},v=s(),p=e=>{v.setMonth(v.getMonth()+e),i||v.setFullYear(2024),k()},h=function(e,t){return(t?e.getFullYear().toString():"0000")+"-"+(e.getMonth()+1).toString().padStart(2,"0")+"-"+e.getDate().toString().padStart(2,"0")},g=function(e){t.value!==e&&(t.value=e,t.dispatchEvent(new Event("change",{bubbles:!0})),o&&w(),k())},b=null,y=function(e,t){void 0===t&&(t=null),clientPackages.get("tooltip").then((function(n){null===b&&(b=n.generateID()),e(n,b+(null!==t?"$"+t:""))}))};if(o){var A=document.createElement("div");A.innerHTML='<div data-form-element-component="picker"></div>',r=A.querySelector('[data-form-element-component="picker"]');var S=null;y((function(o,a){var i=function(){return o.isVisible(a)};o.addClickListener(n,(function(){i()?S(!1):(v=s(),k(),S(!0))})),S=function(l){l!==i()&&(l?(o.show(a,n,r,{showArrow:!1,align:"start",contentSpacing:2,preferedPositions:["bottom","top","left","right"],contentContainer:t.nextSibling,onBeforeShow:function(e){e.setAttribute("data-form-element-component","picker-tooltip")},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),e.setAttribute("data-form-element-data-opened","")):o.hide(a))}}));var w=function(){for(var e=f(t.value),r=[],o=0;o<e.length;o++){var a=e[o].trim();r.push(d(a,i?["date"]:["monthDay","month"]))}n.innerText=r.join(", ")}}var D=function(){var e=t.getAttribute("min");e=null!==e?new Date(e):null;var n=t.getAttribute("max");return[e,n=null!==n?new Date(n):null]},k=function(){var n=""!==t.value,a='<div data-form-element-component="header">';l&&(a+='<div data-form-element-component="clear-button"></div>'),a+='<div data-form-element-component="month-button"></div>',i&&(a+='<div data-form-element-component="year-button"></div>'),a+='<div data-form-element-component="previous-button"></div>',a+='<div data-form-element-component="next-button"></div>',a+="</div>",a+='<div data-form-element-component="dates"></div>',r.innerHTML=a;var s=r.querySelector('[data-form-element-component="dates"]'),b=r.querySelector('[data-form-element-component="month-button"]'),A=r.querySelector('[data-form-element-component="year-button"]'),w=r.querySelector('[data-form-element-component="previous-button"]'),E=r.querySelector('[data-form-element-component="next-button"]');if(l)var T=r.querySelector('[data-form-element-component="clear-button"]');w.addEventListener("click",(function(){p(-1)})),E.addEventListener("click",(function(){p(1)})),l&&(T.addEventListener("click",(function(){""!==t.value&&(v=c(),g(""),o&&S(!1))})),T.style.setProperty("opacity",n?"1":"0"),T.style.setProperty("pointer-events",n?"auto":"none"));var x=D(),C=x[0],F=x[1],M=v.getMonth(),q=function(e,t,n,o){y((function(t,a){t.addClickListener(e,(function(){if(t.isVisible(a))t.hide(a);else{var i=document.createElement("div"),l=o(i,(function(){t.hide(a)}));if(t.show(a,e,i,{showArrow:!1,align:"center",contentSpacing:2,preferedPositions:["bottom","top","left","right"],contentContainer:r,onBeforeShow:function(e){e.setAttribute("data-form-element-component",n)},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),null!==l){l.setAttribute("data-form-element-data-selected","");var u=l.parentNode,m=l.getBoundingClientRect(),d=u.getBoundingClientRect();u.scrollTop=Math.round(Math.abs(m.y-d.y)-(d.height-m.height)/2)}e.setAttribute("data-form-element-data-opened","")}}))}),t)};b.innerText=d(v,["month"]),q(b,"m","months-tooltip",(function(e,t){e.setAttribute("data-form-element-component","months");for(var n=1;n<=12;n++){var r=document.createElement("div");r.setAttribute("data-form-element-component","month"),r.setAttribute("data-form-element-data-value",n),r.innerText=d("2000-"+n+"-1",["month"]),r.addEventListener("click",function(e){return function(){v.setMonth(e-1),t(),k()}}(n)),e.appendChild(r)}return e.querySelector('[data-form-element-data-value="'+(v.getMonth()+1)+'"]')})),null!==A&&(A.innerText=d(v,["year"]),q(A,"y","years-tooltip",(function(e,t){e.setAttribute("data-form-element-component","years");for(var n=c().getFullYear(),r=n-200;r<=n+200;r++){var o=document.createElement("div");o.setAttribute("data-form-element-component","year"),o.setAttribute("data-form-element-data-value",r),o.innerText=r.toString(),o.addEventListener("click",function(e){return function(){v.setFullYear(e),t(),k()}}(r)),e.appendChild(o)}return e.querySelector('[data-form-element-data-value="'+v.getFullYear()+'"]')})));var L=new Date(v);if(L.setDate(1),i){var Y=L.getDay();0===Y&&(Y=7),L.setDate(L.getDate()+1-Y)}if(i)for(var P=[d("2000-01-03",["weekDayShort"]),d("2000-01-04",["weekDayShort"]),d("2000-01-05",["weekDayShort"]),d("2000-01-06",["weekDayShort"]),d("2000-01-07",["weekDayShort"]),d("2000-01-08",["weekDayShort"]),d("2000-01-09",["weekDayShort"])],B=0;B<7;B++){(j=document.createElement("div")).setAttribute("data-form-element-component","day"),j.innerText=P[B],s.appendChild(j)}var I=h(c(),i),V=f(t.value),H=i?6:5;for(B=0;B<7*H;B++){var O=!1;(null!==C&&C.getTime()>L.getTime()||null!==F&&F.getTime()<L.getTime())&&(O=!0);var j,R=h(L,i);(j=document.createElement("div")).setAttribute("data-form-element-component","date"),j.setAttribute("data-form-element-data-value",R),j.setAttribute("data-form-element-data-day",B%7==5||B%7==6?"weekend":"weekday"),j.setAttribute("data-form-element-data-month",L.getMonth()===M?"current":"other"),-1!==V.indexOf(R)&&j.setAttribute("data-form-element-data-selected",""),R===I&&j.setAttribute("data-form-element-data-today",""),j.innerText=L.getDate().toString(),O?j.setAttribute("data-form-element-data-disabled",""):j.addEventListener("click",function(e){return function(){var n;if(m)if(u){var r=f(t.value);-1===r.indexOf(e)?r.push(e):(n=e,r=r.filter(e=>e!==n)),r.sort(),g(r.join(";",r)),k()}else g(e),o&&S(!1)}}(R)),s.appendChild(j),L.setDate(L.getDate()+1)}e.dispatchEvent(new Event("pickerUpdate",{bubbles:!1}))};a&&k(),e.showMonth=function(e,t){var n=new Date(v.getTime()),r=!1;void 0!==e&&(e=parseInt(e))>=1&&e<=12&&(e--,n.getMonth()!==e&&(n.setMonth(e),r=!0)),i&&void 0!==t&&(t=parseInt(t))>0&&n.getFullYear()!==t&&(n.setFullYear(t),r=!0);var o=D(),a=o[0],l=o[1];null!==a&&a.getTime()>n.getTime()?(n=a,r=!0):null!==l&&l.getTime()<n.getTime()&&(n=l,r=!0),r&&(v=n,k())},e.setCurrentDate=function(e){null==e?t.removeAttribute("currentDate"):t.setAttribute("currentDate",e),k()},t.getFormElementContainer=function(){return e},e.getValue=function(){return t.value},e.setValue=function(e){t.value=e,o&&w()},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")}}}(elements[i]);
EOT;
