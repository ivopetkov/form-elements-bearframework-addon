<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='datetime']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("input"),n=e.querySelector('[data-form-element-component="button"]'),a=e.querySelector('[data-form-element-component="picker"]'),r=null!==n,o=null!==a,i=-1!==[null,"true"].indexOf(t.getAttribute("showDate")),u=-1!==["true"].indexOf(t.getAttribute("showTime")),l=-1!==["true"].indexOf(t.getAttribute("showTimeDuration")),d=-1!==["true"].indexOf(t.getAttribute("showSeconds")),m=-1!==[null,"true"].indexOf(t.getAttribute("showYear")),c=-1!==[null,"true"].indexOf(t.getAttribute("showClear")),s=-1!==["true"].indexOf(t.getAttribute("showOK")),f=-1!==["","true"].indexOf(t.getAttribute("multiple")),v=-1!==[null,"true"].indexOf(t.getAttribute("allowSelect")),p=-1!==["true"].indexOf(t.getAttribute("allowSwipe")),g=t.getAttribute("hoursLabel"),h=t.getAttribute("minutesLabel"),b=t.getAttribute("secondsLabel");l&&(u=!0);var S=ivoPetkovBearFrameworkAddonsFormElementsDateTimeFormatDate;r&&n.addEventListener("keydown",(function(e){32===e.keyCode&&(n.click(),e.preventDefault(),e.stopPropagation())}));var y=function(){var e=t.getAttribute("currentDate");return null!==e?new Date(e):new Date},A=function(e,t){var n=[];if(null!=e)for(var a=e.split(";"),r=0;r<a.length;r++){var o=a[r].trim();if(o.length>0)if(t){var i=x(o);n.push(i[0])}else n.push(o)}return n},x=e=>{null==e&&(e="");var t=e.split("T"),n=t[0],a=void 0!==t[1]?t[1]:"";return-1!==n.indexOf(":")&&(a=n,n=""),[n,a]},D=function(e){return""!==x(e)[1]},w=function(e,t,n){var a=x(e);if(""!==a[1]){var r=a[1].split(":");if(void 0!==r[t])return parseInt(r[t]).toString()}return void 0!==n?n:""},k=function(){var e=A(t.value,!1);e.sort().reverse();var n=e.length>0?e[0]:"";m||(n=n.replace("0000-","2024-"));var a=0;u&&(a=w(n,0,0)),""===n||i||(n="1111-11-11T"+(a>23?23:a).toString().padStart(2,"0")+":"+w(n,1,0).toString().padStart(2,"0")+":"+w(n,2,0).toString().padStart(2,"0"));var r=""!==n?new Date(n):y();return m||L(r,2024),u&&(r.setHours(a>23?23:a),r.setMinutes(w(n,1,0)),r.setSeconds(w(n,2,0))),{date:r,hours:a}},T=function(e,t){return new Date(e,t+1,0).getDate()},E=function(e,t){var n=e.getDate();e.setDate(1),e.setMonth(t);var a=T(e.getFullYear(),t);e.setDate(a<n?a:n)},L=function(e,t){var n=e.getDate();e.setDate(1),e.setFullYear(t);var a=T(t,e.getMonth());e.setDate(a<n?a:n)},q=function(e){var t=e.date,n="";return i&&(n+=(m?t.getFullYear().toString():"0000")+"-"+(t.getMonth()+1).toString().padStart(2,"0")+"-"+t.getDate().toString().padStart(2,"0")),u&&(t.getHours()>0||t.getMinutes()>0||t.getSeconds()>0)&&(i&&(n+="T"),n+=l?e.hours:t.getHours().toString().padStart(2,"0"),n+=":"+t.getMinutes().toString().padStart(2,"0"),d&&(n+=":"+t.getSeconds().toString().padStart(2,"0"))),n},M=function(e,t){for(var n=x(e)[0],a=0;a<t.length;a++)if(n===x(t[a])[0])return!0;return!1},C=k(),O=e=>{E(C.date,C.date.getMonth()+e),m||L(C.date,2024),R()},F=function(e,n,a){t.value!==e&&(t.value=e,C=k(),t.dispatchEvent(new Event("change",{bubbles:!0})),n&&r&&V(),a&&R())},H=function(e,t){F(q(C),e,t)},I=function(e){for(var t=e.split(":"),n=0;n<t.length;n++)t[n]=t[n].padStart(2,"0");return t.join(":")},P=null,N=function(e,t){void 0===t&&(t=null),clientPackages.get("tooltip").then((function(n){null===P&&(P=n.generateID()),e(n,P+(null!==t?"$"+t:""))}))};if(r){var Y=document.createElement("div");Y.innerHTML='<div data-form-element-component="picker"></div>',a=Y.querySelector('[data-form-element-component="picker"]');var B=null;N((function(r,o){var i=function(){return r.isVisible(o)};r.addClickListener(n,(function(){i()?B(!1):(C=k(),R(),B(!0))})),B=function(u){u!==i()&&(u?(r.show(o,n,a,{align:"start",preferedPositions:["bottom","top","left","right"],contentContainer:t.nextSibling,onBeforeShow:function(e){e.setAttribute("data-form-element-component","picker-tooltip")},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),e.setAttribute("data-form-element-data-opened","")):r.hide(o))}}));var V=function(){for(var e=A(t.value,!1),a=[],r=0;r<e.length;r++){var o=e[r].trim(),c=[];i&&(m?c.push("date"):(c.push("monthDay"),c.push("month"))),(u||l)&&(i&&-1===o.indexOf("T")||(c.push("time"),d&&c.push("seconds")),i||""===o||(o="1111-11-11T"+I(o)+(d?"":":00"))),a.push(S(o,c))}n.innerText=a.join(", ")}}var K=function(){var e=t.getAttribute("min");e=null!==e?new Date(e):null;var n=t.getAttribute("max");return[e,n=null!==n?new Date(n):null]},j=function(e,t,n,r){N((function(t,o){t.addClickListener(e,(function(){if(t.isVisible(o))t.hide(o);else{var i=document.createElement("div"),u=r(i,(function(){t.hide(o)}));if(t.show(o,e,i,{align:"center",preferedPositions:["bottom","top","left","right"],contentContainer:a,onBeforeShow:function(e){e.setAttribute("data-form-element-component",n)},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),null!==u){u.setAttribute("data-form-element-data-selected","");var l=u.parentNode,d=u.getBoundingClientRect(),m=l.getBoundingClientRect();l.scrollTop=Math.round(Math.abs(d.y-m.y)-(m.height-d.height)/2)}e.setAttribute("data-form-element-data-opened","")}}))}),t)},R=function(){var n=""!==t.value,o="";if((c||i)&&(o+='<div data-form-element-component="header">',c&&(o+='<div data-form-element-component="clear-button"></div>'),i&&(o+='<div data-form-element-component="month-button"></div>',m&&(o+='<div data-form-element-component="year-button"></div>'),o+='<div data-form-element-component="previous-button"></div>',o+='<div data-form-element-component="next-button"></div>'),o+="</div>"),i&&(o+='<div data-form-element-component="dates"></div>'),u&&(o+='<div data-form-element-component="time">',o+='<div data-form-element-component="time-hours-element">',o+='<div data-form-element-component="time-hours-label">'+g+"</div>",o+='<input type="text" data-form-element-component="time-hours-textbox"></input>',o+="</div>",o+='<div data-form-element-component="time-separator">:</div>',o+='<div data-form-element-component="time-minutes-element">',o+='<div data-form-element-component="time-minutes-label">'+h+"</div>",o+='<input type="text" data-form-element-component="time-minutes-textbox"></input>',o+="</div>",d&&(o+='<div data-form-element-component="time-separator">:</div>',o+='<div data-form-element-component="time-seconds-element">',o+='<div data-form-element-component="time-seconds-label">'+b+"</div>",o+='<input type="text" data-form-element-component="time-seconds-textbox"></input>',o+="</div>"),o+="</div>"),s&&(o+='<div data-form-element-component="ok-button">OK</div>'),a.innerHTML=o,i)var x=a.querySelector('[data-form-element-component="dates"]'),k=a.querySelector('[data-form-element-component="month-button"]'),T=a.querySelector('[data-form-element-component="year-button"]'),I=a.querySelector('[data-form-element-component="previous-button"]'),P=a.querySelector('[data-form-element-component="next-button"]');if(c)var N=a.querySelector('[data-form-element-component="clear-button"]');if(s)var Y=a.querySelector('[data-form-element-component="ok-button"]');if(u){var V=a.querySelector('[data-form-element-component="time-hours-textbox"]'),U=a.querySelector('[data-form-element-component="time-minutes-textbox"]');if(d)var $=a.querySelector('[data-form-element-component="time-seconds-textbox"]');var z=function(e,t,n,a,o,i,u,l){if(null!==e){e.value=u(),e.addEventListener("change",(function(){var t=e.value;if(""!==t){var r=parseInt(t);isNaN(r)?t=0:r>=n&&!a&&(t=n)}l(t),H(!0,!1),e.value=""!==t?u():"",X()}));var d=null,m=function(){try{d()}catch(e){}},c=function(t){var r=e.value;if(t>0&&""===r&&(r="0"),""!==r){var o=parseInt(r);isNaN(o)||((o+=t)<0&&(o=0),o>n&&!a&&(o=n),l(o),H(!0,!1),e.value=u(),X())}};e.addEventListener("keydown",(function(t){var n=t.keyCode;if(9===n)m();else if(40===n)m(),c(t.shiftKey?10:1);else if(38===n)m(),c(t.shiftKey?-10:-1);else if(13===n){m();var a=null!==e.parentNode.nextSibling?e.parentNode.nextSibling.nextSibling.lastChild:null;null!==a?a.focus():(e.blur(),r&&B(!1))}})),e.setAttribute("tabindex","0"),j(e,t,"time-"+o+"-tooltip",(function(a,r){d=r,a.setAttribute("data-form-element-component","time-"+o);for(var m=0;m<=n;m++){var c=document.createElement("div");c.setAttribute("data-form-element-component","time-"+i),c.setAttribute("data-form-element-data-value",m),c.innerText=-1!==["tm","ts"].indexOf(t)?m.toString().padStart(2,"0"):m,c.addEventListener("click",function(t){return function(){r(),l(t),H(!0,!1),e.value=u(),X()}}(m)),a.appendChild(c)}return a.querySelector('[data-form-element-data-value="'+m+'"]')}))}};z(V,"th",23,l,"hours","hour",(function(){return D(t.value)?w(t.value,0).toString():""}),(function(e){var t=""!==e?parseInt(e):0;C.hours=t,C.date.setHours(l&&t>23?23:t)})),z(U,"tm",59,!1,"minutes","minute",(function(){return D(t.value)?w(t.value,1).toString().padStart(2,"0"):""}),(function(e){C.date.setMinutes(""!==e?e:0)})),d&&z($,"ts",59,!1,"seconds","second",(function(){return D(t.value)?w(t.value,2).toString().padStart(2,"0"):""}),(function(e){C.date.setSeconds(""!==e?e:0)}))}i&&(I.addEventListener("click",(function(){O(-1)})),P.addEventListener("click",(function(){O(1)}))),c&&(N.addEventListener("click",(function(){""!==t.value&&(C.date=y(),C.hours=0,F("",!0,!0),r&&B(!1))})),N.style.setProperty("opacity",n?"1":"0"),N.style.setProperty("pointer-events",n?"auto":"none")),s&&Y.addEventListener("click",(function(){r&&B(!1)}));var G=K(),J=G[0],Q=G[1];if(i){var W=C.date.getMonth();k.innerText=S(C.date,["month"]),j(k,"m","months-tooltip",(function(e,t){e.setAttribute("data-form-element-component","months");for(var n=1;n<=12;n++){var a=document.createElement("div");a.setAttribute("data-form-element-component","month"),a.setAttribute("data-form-element-data-value",n),a.innerText=S("2000-"+n+"-1",["month"]),a.addEventListener("click",function(e){return function(){E(C.date,e-1),t(),R()}}(n)),e.appendChild(a)}return e.querySelector('[data-form-element-data-value="'+(C.date.getMonth()+1)+'"]')})),null!==T&&(T.innerText=S(C.date,["year"]),j(T,"y","years-tooltip",(function(e,t){e.setAttribute("data-form-element-component","years");for(var n=y().getFullYear(),a=n-200;a<=n+200;a++){var r=document.createElement("div");r.setAttribute("data-form-element-component","year"),r.setAttribute("data-form-element-data-value",a),r.innerText=a.toString(),r.addEventListener("click",function(e){return function(){L(C.date,e),t(),R()}}(a)),e.appendChild(r)}return e.querySelector('[data-form-element-data-value="'+C.date.getFullYear()+'"]')})));var Z=new Date(C.date);if(Z.setDate(1),m){var _=Z.getDay();0===_&&(_=7),Z.setDate(Z.getDate()+1-_)}if(m)for(var ee=[S("2000-01-03",["weekDayShort"]),S("2000-01-04",["weekDayShort"]),S("2000-01-05",["weekDayShort"]),S("2000-01-06",["weekDayShort"]),S("2000-01-07",["weekDayShort"]),S("2000-01-08",["weekDayShort"]),S("2000-01-09",["weekDayShort"])],te=0;te<7;te++){(ue=document.createElement("div")).setAttribute("data-form-element-component","day"),ue.innerText=ee[te],x.appendChild(ue)}var ne=y(),ae=q({date:ne,hours:ne.getHours()}),re=A(t.value,!0),oe=m?6:5;for(te=0;te<7*oe;te++){var ie=!1;(null!==J&&J.getTime()>Z.getTime()||null!==Q&&Q.getTime()<Z.getTime())&&(ie=!0);var ue,le=q({date:Z,hours:0});(ue=document.createElement("div")).setAttribute("data-form-element-component","date"),ue.setAttribute("data-form-element-data-value",le),ue.setAttribute("data-form-element-data-day",te%7==5||te%7==6?"weekend":"weekday"),ue.setAttribute("data-form-element-data-month",Z.getMonth()===W?"current":"other"),M(le,re)&&ue.setAttribute("data-form-element-data-selected",""),le===ae&&ue.setAttribute("data-form-element-data-today",""),ue.innerText=Z.getDate().toString(),ie?ue.setAttribute("data-form-element-data-disabled",""):ue.addEventListener("click",function(e){return function(){var n;if(v)if(f){var a=A(t.value,!0);-1===a.indexOf(e)?a.push(e):(n=e,a=a.filter(e=>e!==n)),a.sort(),F(a.join(";",a),!0,!0)}else{var o=new Date(e);o.setHours(C.date.getHours()),o.setMinutes(C.date.getMinutes()),o.setSeconds(C.date.getSeconds()),F(q({date:o}),!0,!0),r&&B(!1)}}}(le)),x.appendChild(ue),Z.setDate(Z.getDate()+1)}if(p){var de=[null,null];x.addEventListener("touchstart",(function(e){void 0!==e.touches&&(de=[e.touches[0].clientX,(new Date).getTime()])}),!1),x.addEventListener("touchend",(function(e){if(void 0!==e.changedTouches){var t=[e.changedTouches[0].clientX,(new Date).getTime()];t[1]-de[1]>500||(t[0]+80<de[0]?O(1):t[0]-80>de[0]&&O(-1))}}),!1)}}e.dispatchEvent(new Event("pickerUpdate",{bubbles:!1}))};o&&R();var X=function(){for(var e=A(t.value,!0),n=a.querySelectorAll("[data-form-element-data-value]"),r=0;r<n.length;r++){var o=n[r];M(o.getAttribute("data-form-element-data-value"),e)?o.setAttribute("data-form-element-data-selected",""):o.removeAttribute("data-form-element-data-selected")}};e.showMonth=function(e,t){var n=new Date(C.date.getTime()),a=!1;void 0!==e&&(e=parseInt(e))>=1&&e<=12&&(e--,n.getMonth()!==e&&(E(n,e),a=!0)),m&&void 0!==t&&(t=parseInt(t))>0&&n.getFullYear()!==t&&(L(n,t),a=!0);var r=K(),o=r[0],i=r[1];null!==o&&o.getTime()>n.getTime()?(n=o,a=!0):null!==i&&i.getTime()<n.getTime()&&(n=i,a=!0),a&&(C.date=n,R())},e.setCurrentDate=function(e){null==e?t.removeAttribute("currentDate"):t.setAttribute("currentDate",e),R()},t.getFormElementContainer=function(){return e},e.getName=function(){return t.getAttribute("name")},e.getValue=function(){return t.value},e.setValue=function(e){t.value=e,C=k(),r?V():R()},e.focus=function(){var t=e.getFocusTarget();null!==t&&t.focus()},e.getFocusTarget=function(){return r?n:null},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")}}}(elements[i]);
EOT; 
