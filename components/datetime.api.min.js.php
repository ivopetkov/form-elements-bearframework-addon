<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='datetime']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("input"),n=e.querySelector('[data-form-element-component="button"]'),o=e.querySelector('[data-form-element-component="picker"]'),a=null!==n,r=null!==o,i=(t.getAttribute("showTime"),"false"!==t.getAttribute("showYear")),l="false"!==t.getAttribute("showClear"),m=-1!==["true",""].indexOf(t.getAttribute("multiple")),u="false"!==t.getAttribute("allowSelect"),d=ivoPetkovBearFrameworkAddonsFormElementsDateTimeFormatDate;a&&n.addEventListener("keydown",(function(e){13===e.keyCode&&n.click()}));var c=function(e){var t=[];if(null!=e)for(var n=e.split(";"),o=0;o<n.length;o++){var a=n[o].trim();a.length>0&&t.push(a)}return t},f=function(){var e=c(t.value);e.sort().reverse();var n=e.length>0?e[0]:"";i||(n=n.replace("0000-","2024-"));var o=""!==n?new Date(n):new Date;return i||o.setFullYear(2024),o},s=f(),v=e=>{s.setMonth(s.getMonth()+e),i||s.setFullYear(2024),w()},p=function(e,t){return(t?e.getFullYear().toString():"0000")+"-"+(e.getMonth()+1).toString().padStart(2,"0")+"-"+e.getDate().toString().padStart(2,"0")},h=function(e){t.value!==e&&(t.value=e,t.dispatchEvent(new Event("change",{bubbles:!0})),a&&S(),w())},b=null,g=function(e,t){void 0===t&&(t=null),clientPackages.get("tooltip").then((function(n){null===b&&(b=n.generateID()),e(n,b+(null!==t?"$"+t:""))}))};if(a){var y=document.createElement("div");y.innerHTML='<div data-form-element-component="picker"></div>',o=y.querySelector('[data-form-element-component="picker"]');var A=null;g((function(a,r){var i=function(){return a.isVisible(r)};a.addClickListener(n,(function(){i()?A(!1):(s=f(),w(),A(!0))})),A=function(l){l!==i()&&(l?(a.show(r,n,o,{showArrow:!1,align:"start",contentSpacing:2,preferedPositions:["bottom","top","left","right"],contentContainer:t.nextSibling,onBeforeShow:function(e){e.setAttribute("data-form-element-component","picker-tooltip")},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),e.setAttribute("data-form-element-data-opened","")):a.hide(r))}}));var S=function(){for(var e=c(t.value),o=[],a=0;a<e.length;a++){var r=e[a].trim();o.push(d(r,i?["date"]:["monthDay","month"]))}n.innerText=o.join(", ")}}var w=function(){var n=""!==t.value,r='<div data-form-element-component="header">';l&&(r+='<div data-form-element-component="clear-button"></div>'),r+='<div data-form-element-component="month-button"></div>',i&&(r+='<div data-form-element-component="year-button"></div>'),r+='<div data-form-element-component="previous-button"></div>',r+='<div data-form-element-component="next-button"></div>',r+="</div>",r+='<div data-form-element-component="dates"></div>',o.innerHTML=r;var f=o.querySelector('[data-form-element-component="dates"]'),b=o.querySelector('[data-form-element-component="month-button"]'),y=o.querySelector('[data-form-element-component="year-button"]'),S=o.querySelector('[data-form-element-component="previous-button"]'),k=o.querySelector('[data-form-element-component="next-button"]');if(l)var D=o.querySelector('[data-form-element-component="clear-button"]');S.addEventListener("click",(function(){v(-1)})),k.addEventListener("click",(function(){v(1)})),l&&(D.addEventListener("click",(function(){""!==t.value&&(s=new Date,h(""),a&&A(!1))})),D.style.setProperty("opacity",n?"1":"0"),D.style.setProperty("pointer-events",n?"auto":"none"));var E=t.getAttribute("min");E=null!==E?new Date(E):null;var T=t.getAttribute("max");T=null!==T?new Date(T):null;var x=s.getMonth(),q=function(e,t,n,a){g((function(t,r){t.addClickListener(e,(function(){if(t.isVisible(r))t.hide(r);else{var i=document.createElement("div"),l=a(i,(function(){t.hide(r)}));if(t.show(r,e,i,{showArrow:!1,align:"center",contentSpacing:2,preferedPositions:["bottom","top","left","right"],contentContainer:o,onBeforeShow:function(e){e.setAttribute("data-form-element-component",n)},onHide:function(){e.removeAttribute("data-form-element-data-opened","")}}),null!==l){l.setAttribute("data-form-element-data-selected","");var m=l.parentNode,u=l.getBoundingClientRect(),d=m.getBoundingClientRect();m.scrollTop=Math.round(Math.abs(u.y-d.y)-(d.height-u.height)/2)}e.setAttribute("data-form-element-data-opened","")}}))}),t)};b.innerText=d(s,["month"]),q(b,"m","months-tooltip",(function(e,t){e.setAttribute("data-form-element-component","months");for(var n=1;n<=12;n++){var o=document.createElement("div");o.setAttribute("data-form-element-component","month"),o.setAttribute("data-form-element-data-value",n),o.innerText=d("2000-"+n+"-1",["month"]),o.addEventListener("click",function(e){return function(){s.setMonth(e-1),t(),w()}}(n)),e.appendChild(o)}return e.querySelector('[data-form-element-data-value="'+(s.getMonth()+1)+'"]')})),null!==y&&(y.innerText=d(s,["year"]),q(y,"y","years-tooltip",(function(e,t){e.setAttribute("data-form-element-component","years");for(var n=(new Date).getFullYear(),o=n-200;o<=n+200;o++){var a=document.createElement("div");a.setAttribute("data-form-element-component","year"),a.setAttribute("data-form-element-data-value",o),a.innerText=o.toString(),a.addEventListener("click",function(e){return function(){s.setFullYear(e),t(),w()}}(o)),e.appendChild(a)}return e.querySelector('[data-form-element-data-value="'+s.getFullYear()+'"]')})));var C=new Date(s);if(C.setDate(1),i){var F=C.getDay();0===F&&(F=7),C.setDate(C.getDate()+1-F)}if(i)for(var L=[d("2000-01-03",["weekDayShort"]),d("2000-01-04",["weekDayShort"]),d("2000-01-05",["weekDayShort"]),d("2000-01-06",["weekDayShort"]),d("2000-01-07",["weekDayShort"]),d("2000-01-08",["weekDayShort"]),d("2000-01-09",["weekDayShort"])],M=0;M<7;M++){(H=document.createElement("div")).setAttribute("data-form-element-component","day"),H.innerText=L[M],f.appendChild(H)}var P=p(new Date,i),Y=c(t.value),B=i?6:5;for(M=0;M<7*B;M++){var V=!1;(null!==E&&E.getTime()>C.getTime()||null!==T&&T.getTime()<C.getTime())&&(V=!0);var H,I=p(C,i);(H=document.createElement("div")).setAttribute("data-form-element-component","date"),H.setAttribute("data-form-element-data-value",I),H.setAttribute("data-form-element-data-day",M%7==5||M%7==6?"weekend":"weekday"),H.setAttribute("data-form-element-data-month",C.getMonth()===x?"current":"other"),-1!==Y.indexOf(I)&&H.setAttribute("data-form-element-data-selected",""),I===P&&H.setAttribute("data-form-element-data-today",""),H.innerText=C.getDate().toString(),V?H.setAttribute("data-form-element-data-disabled",""):H.addEventListener("click",function(e){return function(){var n;if(u)if(m){var o=c(t.value);-1===o.indexOf(e)?o.push(e):(n=e,o=o.filter(e=>e!==n)),o.sort(),h(o.join(";",o)),w()}else h(e),a&&A(!1)}}(I)),f.appendChild(H),C.setDate(C.getDate()+1)}e.dispatchEvent(new Event("pickerUpdate",{bubbles:!1}))};r&&w(),t.getFormElementContainer=function(){return e},e.getValue=function(){return t.value},e.setValue=function(e){t.value=e,a&&S()},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")}}}(elements[i]);
EOT;
