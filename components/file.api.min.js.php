<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='file']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("[data-form-element-component='clear-button']"),n=e.querySelector("[data-form-element-component='text']"),r=e.querySelector("input"),l=e.querySelectorAll("label"),i=l[l.length-1],a=r.getAttribute("data-form-element-data-max-size");""===a?a=null:null!==a&&(a=parseInt(a)),r.getFormElementContainer=function(){return e},i.getFormElementContainer=function(){return e};var o=[],u=function(e){for(var t=0;t<o.length;t++){var n=o[t];if(n[0]===e)return n[1]}return null};e.getName=function(){return r.getAttribute("name")},e.getValue=function(){var e=r.files,t=e.length;if(0===t)return r.getAttribute("data-value");for(var n=[],l=0;l<t;l++){var i=e[l],a=u(i);null!==a?n.push(a):n.push({value:i.name,filename:null,size:i.size,type:i.type})}return JSON.stringify(n)},e.setValue=function(e){if(null!==e&&""!==e)throw new Error("Only empty string allowed!");r.value="",r.setAttribute("data-value",""),r.dispatchEvent(new Event("change"))},e.hasValue=function(){return""!==e.getValue()},e.getUploadDetails=function(e){for(var t=r.files,n=t.length,l=0;l<n;l++){var i=t[l];if(u(i)===e)return{name:i.name,size:i.size,type:i.type}}return null},e.hasPendingUploads=function(){for(var e=r.files,t=e.length,n=0;n<t;n++){if(!u(e[n]))return!0}return!1},e.upload=function(e,t,n,l,i){for(var f=r.files,s=f.length,m=0,v=[],c=0;c<s;c++){var d=f[c];if(null!==a&&d.size>a)return void l(ivoPetkovBearFrameworkAddonsFormElementsFileGetText("ivopetkov.form-element.file.TooBig").replace("%s",ivoPetkovBearFrameworkAddonsFormElementsFileFormatBytes(a)));null===u(d)?(v[c]=0,m++):v[c]=100}var g=function(r){if(void 0!==f[r]){var a=f[r];null===u(a)&&e(a,(function(e){g(r+1),m--,o.push([a,e]),0===m&&t()}),(function(e){void 0!==n&&n(e)}),(function(e){void 0!==l&&l(e)}),(function(e){v[r]=e,function(){if(void 0!==i){for(var e=0,t=0;t<s;t++)e+=v[t];i(e/s)}}()}))}};g(0)},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")},null!==t&&t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault(),e.setValue("")}),!1);var f=function(){var l=r.files.length;if(0===l)n.innerText=0===e.getValue().length?"CHOOSE_TEXT_TO_REPLACE":"",null!==t&&(t.style.display="none");else{if(1===l)var i=r.files[0].name;else i="SELECTED_FILES_COUNT_TEXT_TO_REPLACE".replace("%s",l);n.innerText=i,null!==t&&(t.style.display="inline-block")}};r.addEventListener("change",(function(){f(),e.hasValue()?r.setAttribute("data-has-value","true"):r.removeAttribute("data-has-value"),setTimeout(f,1)}),!1)}}(elements[i]);
EOT;
