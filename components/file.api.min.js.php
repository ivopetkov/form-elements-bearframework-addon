<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='file']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("[data-form-element-component='clear-button']"),n=e.querySelector("[data-form-element-component='text']"),r=e.querySelector("input"),a=e.querySelectorAll("label"),l=a[a.length-1],o=r.getAttribute("data-form-element-data-max-size");""===o?o=null:null!==o&&(o=parseInt(o));var i=null,u=function(){return null!==i?i:r.files};r.getFormElementContainer=function(){return e},l.getFormElementContainer=function(){return e},l.addEventListener("keydown",(function(e){13!==e.keyCode&&32!==e.keyCode||(l.click(),e.preventDefault(),e.stopPropagation())}));var s=function(e){e.preventDefault(),e.stopPropagation(),l.setAttribute("data-form-element-event","drag-over")},f=function(e){e.preventDefault(),e.stopPropagation(),l.removeAttribute("data-form-element-event")};l.addEventListener("dragenter",s,!1),l.addEventListener("dragover",s,!1),l.addEventListener("dragleave",f,!1),l.addEventListener("drop",(function(e){f(e);var t=r.getAttribute("accept"),n=null!==t&&""!==t?t.split(","):[];n=n.map((function(e){return e.trim().toLowerCase()})),i=[];for(var a=e.dataTransfer.files,l=0;l<a.length;l++){var o=a[l],u=o.name.toLowerCase(),s=!1;for(var v of n)if(v===u.substring(u.length-v.length)){s=!0;break}s&&i.push(o)}m=!1,r.dispatchEvent(new Event("change",{bubbles:!0})),m=!0}),!1);var v=[],d=function(e){for(var t=0;t<v.length;t++){var n=v[t];if(n[0]===e)return n[1]}return null};e.getName=function(){return r.getAttribute("name")},e.getValue=function(){var e=u(),t=e.length;if(0===t)return r.getAttribute("data-value");for(var n=[],a=0;a<t;a++){var l=e[a],o=d(l);null!==o?n.push(o):n.push({value:l.name,filename:null,size:l.size,type:l.type})}return JSON.stringify(n)},e.setValue=function(e){if(null!==e&&""!==e)throw new Error("Only empty string allowed!");i=null,r.value="",r.setAttribute("data-value",""),r.dispatchEvent(new Event("change",{bubbles:!0}))},e.hasValue=function(){return""!==e.getValue()},e.getUploadDetails=function(e){for(var t=u(),n=t.length,r=0;r<n;r++){var a=t[r];if(d(a)===e)return{name:a.name,size:a.size,type:a.type}}return null},e.hasPendingUploads=function(){for(var e=u(),t=e.length,n=0;n<t;n++){if(!d(e[n]))return!0}return!1},e.upload=function(e,t,n,r,a){for(var l=u(),i=l.length,s=0,f=[],c=0;c<i;c++){var m=l[c];if(null!==o&&m.size>o)return void r(ivoPetkovBearFrameworkAddonsFormElementsFileGetText("ivopetkov.form-element.file.TooBig").replace("%s",ivoPetkovBearFrameworkAddonsFormElementsFileFormatBytes(o)));null===d(m)?(f[c]=0,s++):f[c]=100}var g=function(o){if(void 0!==l[o]){var u=l[o];null===d(u)&&e(u,(function(e){g(o+1),s--,v.push([u,e]),0===s&&t()}),(function(e){void 0!==n&&n(e)}),(function(e){void 0!==r&&r(e)}),(function(e){f[o]=e,function(){if(void 0!==a){for(var e=0,t=0;t<i;t++)e+=f[t];a(e/i)}}()}))}};g(0)},e.focus=function(){var t=e.getFocusTarget();null!==t&&t.focus()},e.getFocusTarget=function(){return l},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")},null!==t&&t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault(),e.setValue("")}),!1);var c=function(){var r=u(),a=r.length;if(0===a)n.innerText=0===e.getValue().length?"CHOOSE_TEXT_TO_REPLACE":"",null!==t&&(t.style.display="none");else{if(1===a)var l=r[0].name;else l="SELECTED_FILES_COUNT_TEXT_TO_REPLACE".replace("%s",a);n.innerText=l,null!==t&&(t.style.display="inline-block")}},m=!0;r.addEventListener("change",(function(){m&&(i=null),c(),e.hasValue()?r.setAttribute("data-has-value","true"):r.removeAttribute("data-has-value"),setTimeout(c,1)}),!1)}}(elements[i]);
EOT;
