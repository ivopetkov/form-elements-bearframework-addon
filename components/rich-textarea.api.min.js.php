<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='rich-textarea']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("div"),n=-1!==["true"].indexOf(t.getAttribute("noLines")),r=t.getAttribute("autoHighlight");null===r&&(r=""),r=(r=r.trim()).length>0?(r=r.split(",")).map((function(e){return e.trim()})):[];var l=function(e){return-1!==r.indexOf("*")||-1!==r.indexOf(e)},i=function(e){for(var r=!1,l=t.querySelectorAll("*"),a=0;a<l.length;a++){var o=l[a],u=o.tagName.toLowerCase();if(n)if("br"===u){if(null!==o.nextSibling){var d=document.createElement("span");o.parentNode.replaceChild(d,o),r=!0}}else if("div"===u){(d=document.createElement("span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(d,o),o=d,r=!0}if(-1===["br","span","div","a"].indexOf(u))(d=document.createElement("block"===window.getComputedStyle(o).display?"div":"span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(d,o),o=d,r=!0;var c=o.attributes;if(c.length>0){for(var f=[],h=0;h<c.length;h++)f.push(c[h].name);for(h=0;h<f.length;h++){var s=f[h];"a"===u&&-1!==["data-rich-textarea-link-type"].indexOf(s)||(o.removeAttribute(s),r=!0)}}}t.childNodes;if(1===t.childNodes.length){var g=t.firstChild;1===g.nodeType&&"br"===g.tagName.toLowerCase()&&(t.removeChild(g),r=!0)}r&&--e>0&&i(e)},a=function(){var e=window.getSelection();return"Caret"===e.type?{node:e.anchorNode,offset:e.anchorOffset}:null},o=function(e,t){try{var n=window.getSelection(),r=new Range;r.setStart(1===e.nodeType?e.firstChild:e,t),r.collapse(!0),n.removeAllRanges(),n.addRange(r)}catch(e){}},u=null,d=null,c=function(e){clientPackages.get("tooltip").then((function(t){d=t,function(){null===u&&(u=d.generateID());var t=e.getAttribute("data-rich-textarea-link-type"),n=e.innerText,r="",l=null,i=null;if("url"===t?(-1===n.indexOf("//")&&(n="https://"+n),r='<a href="'+n+'" target="_blank" rel="noopener" data-rich-textarea-highlight-tooltip-component="open">OPEN_URL_TEXT_TO_REPLACE</a>',l=n,i=n):"email"===t?(r='<a href="mailto:'+n+'" target="_blank" rel="noopener" data-rich-textarea-highlight-tooltip-component="email">EMAIL_TEXT_TO_REPLACE</a>',l=n):"phone"===t&&(r='<a href="tel:'+n+'" target="_blank" rel="noopener" data-rich-textarea-highlight-tooltip-component="call">CALL_TEXT_TO_REPLACE</a>',l=n),0!==r.length){var a=!1;null!==l&&void 0!==navigator.clipboard&&(r+='<a data-rich-textarea-highlight-tooltip-component="copy" title="COPY_TEXT_TO_REPLACE"></a>',a=!0);var o=!1;null!==i&&void 0!==navigator.share&&(r+='<a data-rich-textarea-highlight-tooltip-component="share" title="SHARE_TEXT_TO_REPLACE"></a>',o=!0);var c=function(){d.hide(u)};d.show(u,e,r,{align:"center",preferedPositions:["bottom","top","left","right"],onBeforeShow:function(e){e.setAttribute("data-form-element-component","highlight-tooltip"),e.querySelector("a[href]").addEventListener("click",(function(){c()})),a&&e.querySelector('[data-rich-textarea-highlight-tooltip-component="copy"]').addEventListener("click",(function(){navigator.clipboard.writeText(l),c(),clientPackages.get("notifications").then(e=>{e.show("COPIED_TEXT_TO_REPLACE",{autoHide:!0})}).catch(e=>{})})),o&&e.querySelector('[data-rich-textarea-highlight-tooltip-component="share"]').addEventListener("click",(function(){navigator.share({url:i}),c()}))},onShow:function(e){}})}}()}))},f=function(){null!==d&&null!==u&&d.hide(u)},h=function(){if(0!==r.length){var e=t.innerText,n=function(t){for(var n=[],r=null;r=t.exec(e);)n.push(r[0]);return n.sort((function(e,t){return t.length-e.length})),n=n.filter((function(e,t,n){return n.indexOf(e)===t}))},i=[];if(l("email"))for(var u=n(/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim),d=0;d<u.length;d++){var c=u[d];i.push([c,'<a data-rich-textarea-link-type="email">'+c+"</a>"])}if(l("url")){var f=n(/(\b((http|https):\/\/)?(www\.)?([a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+)(\/[a-zA-Z0-9-._~:/?#[\]@!$&'()*+,;%=]*)?)/gim);for(d=0;d<f.length;d++){var h=f[d];i.push([h,'<a data-rich-textarea-link-type="url">'+h+"</a>"])}}if(l("phone")){var s=n(/(?:\+\d{1,3}\s?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}/gim);for(d=0;d<s.length;d++){var v=s[d];i.push([v,'<a data-rich-textarea-link-type="phone">'+v+"</a>"])}}if(l("tag")){var p=n(/#[a-zA-Z0-9-]+/gim);for(d=0;d<p.length;d++){var m=p[d];i.push([m,'<a data-rich-textarea-link-type="tag">'+m+"</a>"])}}var T=function(e){for(var t=0;t<i.length;t++){var n=i[t];if(n[0]===e)return n[1]}return null},b=function(e,t){var n=null!==t?t.offset:null;if(e.length>0){var r=function(e){for(var t=0;t<i.length;t++)for(var n=i[t],l=0;l<e.length;l++){var a=e[l];if(a!==n[0]&&null===T(a)){var o=a.split(n[0]);if(o.length>1){for(var u=[],d=0;d<o.length;d++)d>0&&u.push(n[0]),u.push(o[d]);return r([].concat(e.slice(0,l),u,e.slice(l+1)).filter((function(e){return e.length>0})))}}}return e},l="",a=!1,o=0,u=null,d=null;if(null!==(v=T(e)))l=v,a=!0,o=1,null!==t&&(u=0,d=n);else{var c=r([e]);if((o=c.length)>1)for(var f=0,h=0,s=0;s<c.length;s++){var v,p=c[s];if(l+=null!==(v=T(p))?v:g(p),null!==t){var m=p.length;h+m>=n&&null===u&&(u=f,d=n-h),f++,h+=m}}}if(""!==l)return{html:l,match:a,nodesCount:o,caretNodeIndex:u,caretNodeOffset:d}}return null},x=function(e,t,n){var r=e.parentNode,l=e.previousSibling,i=e.nextSibling,a=document.createElement("span");if(r.insertBefore(a,e),a.insertAdjacentHTML("beforebegin",t.html),r.removeChild(a),null!==n&&(e===n.node||3===n.node.nodeType&&n.node.parentNode===e)){for(var u=e,d=0;d<t.nodesCount-t.caretNodeIndex;d++)u=u.previousSibling;o(u,t.caretNodeOffset)}return r.removeChild(e),null!==l&&E(l),null!==i&&E(i),!0},E=function(e){var t=!1;if(3===e.nodeType){var n=a(),r=null!==n?n.node:null,l=null!==n?n.offset:null,i=e.previousSibling,u=e.nextSibling;if(null!==u&&3===u.nodeType){var d=null;r===e?d=l:r===u&&(d=e.nodeValue.length+l),e.nodeValue+=u.nodeValue,e.parentNode.removeChild(u),null!==d&&o(e,d),t=!0}if(null!==i&&3===i.nodeType){d=null;r===i?d=l:r===e&&(d=i.nodeValue.length+l),i.nodeValue+=e.nodeValue,e.parentNode.removeChild(e),null!==d&&o(i,d),t=!0}}return t},y=a(),C=function(e){for(var t=!1,n=e.childNodes,r=[],l=0;l<n.length;l++)r.push(n[l]);for(l=0;l<r.length;l++){var i=!1,u=r[l];if(1===u.nodeType)if("a"===u.tagName.toLowerCase()){var d=u.innerText;if(null!==(f=b(d,y)))f.match||(x(u,f,y),t=!0,i=!0);else{var c=document.createTextNode(d);e.replaceChild(c,u),(y.node===u||3===y.node.nodeType&&y.node.parentNode===u)&&o(c,y.offset),E(c),t=!0,i=!0}}else C(u)&&(t=!0,i=!0);else if(3===u.nodeType){var f;null!==(f=b(u.textContent,y))&&(x(u,f,y),t=!0,i=!0)}i&&(y=a())}return t};for(d=0;d<100;d++){if(!C(t))break}}},s=new Map,g=function(e){var t=s.get(e);if(void 0!==t)return t;let n=document.createElement("div");n.innerText=e;var r=n.innerHTML;return s.set(e,r),r};t.getFormElementContainer=function(){return e};var v=!1;t.addEventListener("input",(function(){f(),i(100),h(),v=!0})),t.addEventListener("blur",(function(){v&&(t.dispatchEvent(new Event("change",{bubbles:!0})),v=!1)})),h(),t.addEventListener("click",()=>{var e=window.getSelection().anchorNode,n=3===e.nodeType?e.parentNode:e;t.contains(n)&&null!==n.getAttribute("data-rich-textarea-link-type")?c(n):f()});var p=function(e){return null!==e&&1===e.nodeType?e.tagName.toLowerCase():null},m=function(e){return null!==e&&3===e.nodeType},T=function(e,t){var n="",r=p(e);if(null!==r){var l=t?null:e.previousSibling,i=t?null:e.nextSibling;if("div"===r){var a=(s=e.childNodes).length,o=e.firstChild,u=null!==o?o.nextSibling:null,d=e.lastChild;if(a>0)if(null!==l&&"div"!==p(l)&&(n+="\n"),1===a&&"br"===p(o))n+="\n";else if(1===a&&m(o)&&"\n"===o.textContent);else if(2===a&&"br"===p(o)&&m(u)&&"\n"===u.textContent)n+="\n";else{for(var c="",f=0;f<a;f++){var h=s[f];d===h&&"br"===p(d)||(c+=T(h,!1))}"\n"!==c&&(n+=c),null!==i&&(n+="\n")}}else if("br"===r)null!==i&&"div"===p(i)||(n+="\n");else if("a"===r)n+=e.innerText;else if("span"===r){var s;for(a=(s=e.childNodes).length,f=0;f<a;f++)n+=T(s[f],!1)}}else m(e)&&(n+=e.textContent);return n};e.getValue=function(){return T(t,!0)},e.setValue=function(n){n!==e.getValue()&&(t.innerText=n,i(100),h())},e.focus=function(){var t=e.getFocusTarget();null!==t&&t.focus()},e.getFocusTarget=function(){return t},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")},e.isActive=function(){var e=document.activeElement;return t===e||t.contains(e)}}}(elements[i]);
EOT;
