<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='rich-textarea']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var n=e.querySelector("div"),t=-1!==["true"].indexOf(n.getAttribute("noLines")),r=n.getAttribute("autoHighlight");null===r&&(r=""),r=(r=r.trim()).length>0?(r=r.split(",")).map((function(e){return e.trim()})):[];var l=function(e){return-1!==r.indexOf("*")||-1!==r.indexOf(e)},i=function(e){for(var r=!1,l=n.querySelectorAll("*"),a=0;a<l.length;a++){var o=l[a],u=o.tagName.toLowerCase();if(t)if("br"===u){if(null!==o.nextSibling){var f=document.createElement("span");o.parentNode.replaceChild(f,o),r=!0}}else if("div"===u){(f=document.createElement("span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(f,o),o=f,r=!0}if(-1===["br","span","div","a"].indexOf(u))(f=document.createElement("block"===window.getComputedStyle(o).display?"div":"span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(f,o),o=f,r=!0;var d=o.attributes;if(d.length>0){for(var c=[],h=0;h<d.length;h++)c.push(d[h].name);for(h=0;h<c.length;h++){var s=c[h];"a"===u&&-1!==["data-rich-textarea-link-type"].indexOf(s)||(o.removeAttribute(s),r=!0)}}}n.childNodes;if(1===n.childNodes.length){var v=n.firstChild;1===v.nodeType&&"br"===v.tagName.toLowerCase()&&(n.removeChild(v),r=!0)}r&&--e>0&&i(e)},a=function(){var e=window.getSelection();return"Caret"===e.type?{node:e.anchorNode,offset:e.anchorOffset}:null},o=function(e,n){try{var t=window.getSelection(),r=new Range;r.setStart(1===e.nodeType?e.firstChild:e,n),r.collapse(!0),t.removeAllRanges(),t.addRange(r)}catch(e){}},u=null,f=null,d=function(e){clientPackages.get("tooltip").then((function(n){f=n,function(){null===u&&(u=f.generateID());var n=e.getAttribute("data-rich-textarea-link-type"),t=e.innerText,r="";"url"===n?(-1===t.indexOf("//")&&(t="https://"+t),r='<a href="'+t+'" target="_blank" rel="noopener">Open URL</a>'):"email"===n?r='<a href="mailto:'+t+'" target="_blank" rel="noopener">Email</a>':"phone"===n&&(r='<a href="tel:'+t+'" target="_blank" rel="noopener">Call</a>'),0!==r.length&&f.show(u,e,r,{align:"center",preferedPositions:["bottom","top","left","right"],onBeforeShow:function(e){e.setAttribute("data-form-element-component","highlight-tooltip")},onShow:function(e){}})}()}))},c=function(){null!==f&&null!==u&&f.hide(u)},h=function(){if(0!==r.length){var e=n.innerText,t=function(n){for(var t=[],r=null;r=n.exec(e);)t.push(r[0]);return t.sort((function(e,n){return n.length-e.length})),t=t.filter((function(e,n,t){return t.indexOf(e)===n}))},i=[];if(l("email"))for(var u=t(/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim),f=0;f<u.length;f++){var d=u[f];i.push([d,'<a data-rich-textarea-link-type="email">'+d+"</a>"])}if(l("url")){var c=t(/(\b((http|https):\/\/)?(www\.)?([a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+)(\/[a-zA-Z0-9-._~:/?#[\]@!$&'()*+,;%=]*)?)/gim);for(f=0;f<c.length;f++){var h=c[f];i.push([h,'<a data-rich-textarea-link-type="url">'+h+"</a>"])}}if(l("phone")){var s=t(/(?:\+\d{1,3}\s?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}/gim);for(f=0;f<s.length;f++){var g=s[f];i.push([g,'<a data-rich-textarea-link-type="phone">'+g+"</a>"])}}if(l("tag")){var p=t(/#[a-zA-Z0-9-]+/gim);for(f=0;f<p.length;f++){var m=p[f];i.push([m,'<a data-rich-textarea-link-type="tag">'+m+"</a>"])}}var b=function(e){for(var n=0;n<i.length;n++){var t=i[n];if(t[0]===e)return t[1]}return null},x=function(e,n){var t=null!==n?n.offset:null;if(e.length>0){var r=function(e){for(var n=0;n<i.length;n++)for(var t=i[n],l=0;l<e.length;l++){var a=e[l];if(a!==t[0]&&null===b(a)){var o=a.split(t[0]);if(o.length>1){for(var u=[],f=0;f<o.length;f++)f>0&&u.push(t[0]),u.push(o[f]);return r([].concat(e.slice(0,l),u,e.slice(l+1)).filter((function(e){return e.length>0})))}}}return e},l="",a=!1,o=0,u=null,f=null;if(null!==(g=b(e)))l=g,a=!0,o=1,null!==n&&(u=0,f=t);else{var d=r([e]);if((o=d.length)>1)for(var c=0,h=0,s=0;s<d.length;s++){var g,p=d[s];if(l+=null!==(g=b(p))?g:v(p),null!==n){var m=p.length;h+m>=t&&null===u&&(u=c,f=t-h),c++,h+=m}}}if(""!==l)return{html:l,match:a,nodesCount:o,caretNodeIndex:u,caretNodeOffset:f}}return null},y=function(e,n,t){var r=e.parentNode,l=e.previousSibling,i=e.nextSibling,a=document.createElement("span");if(r.insertBefore(a,e),a.insertAdjacentHTML("beforebegin",n.html),r.removeChild(a),null!==t&&(e===t.node||3===t.node.nodeType&&t.node.parentNode===e)){for(var u=e,f=0;f<n.nodesCount-n.caretNodeIndex;f++)u=u.previousSibling;o(u,n.caretNodeOffset)}return r.removeChild(e),null!==l&&C(l),null!==i&&C(i),!0},C=function(e){var n=!1;if(3===e.nodeType){var t=a(),r=null!==t?t.node:null,l=null!==t?t.offset:null,i=e.previousSibling,u=e.nextSibling;if(null!==u&&3===u.nodeType){var f=null;r===e?f=l:r===u&&(f=e.nodeValue.length+l),e.nodeValue+=u.nodeValue,e.parentNode.removeChild(u),null!==f&&o(e,f),n=!0}if(null!==i&&3===i.nodeType){f=null;r===i?f=l:r===e&&(f=i.nodeValue.length+l),i.nodeValue+=e.nodeValue,e.parentNode.removeChild(e),null!==f&&o(i,f),n=!0}}return n},N=a(),T=function(e){for(var n=!1,t=e.childNodes,r=[],l=0;l<t.length;l++)r.push(t[l]);for(l=0;l<r.length;l++){var i=!1,u=r[l];if(1===u.nodeType)if("a"===u.tagName.toLowerCase()){var f=u.innerText;if(null!==(c=x(f,N)))c.match||(y(u,c,N),n=!0,i=!0);else{var d=document.createTextNode(f);e.replaceChild(d,u),(N.node===u||3===N.node.nodeType&&N.node.parentNode===u)&&o(d,N.offset),C(d),n=!0,i=!0}}else T(u)&&(n=!0,i=!0);else if(3===u.nodeType){var c;null!==(c=x(u.textContent,N))&&(y(u,c,N),n=!0,i=!0)}i&&(N=a())}return n};for(f=0;f<100;f++){if(!T(n))break}}},s=new Map,v=function(e){var n=s.get(e);if(void 0!==n)return n;let t=document.createElement("div");t.innerText=e;var r=t.innerHTML;return s.set(e,r),r};n.getFormElementContainer=function(){return e};var g=!1;n.addEventListener("input",(function(){c(),i(100),h(),g=!0})),n.addEventListener("blur",(function(){g&&(n.dispatchEvent(new Event("change",{bubbles:!0})),g=!1)})),h(),n.addEventListener("click",()=>{var e=window.getSelection().anchorNode,t=3===e.nodeType?e.parentNode:e;n.contains(t)&&null!==t.getAttribute("data-rich-textarea-link-type")?d(t):c()});var p=function(e){return null!==e&&1===e.nodeType?e.tagName.toLowerCase():null},m=function(e){return null!==e&&3===e.nodeType},b=function(e,n){var t="",r=p(e);if(null!==r){var l=n?null:e.previousSibling,i=n?null:e.nextSibling;if("div"===r){var a=(s=e.childNodes).length,o=e.firstChild,u=null!==o?o.nextSibling:null,f=e.lastChild;if(a>0)if(null!==l&&"div"!==p(l)&&(t+="\n"),1===a&&"br"===p(o))t+="\n";else if(1===a&&m(o)&&"\n"===o.textContent);else if(2===a&&"br"===p(o)&&m(u)&&"\n"===u.textContent)t+="\n";else{for(var d="",c=0;c<a;c++){var h=s[c];f===h&&"br"===p(f)||(d+=b(h,!1))}"\n"!==d&&(t+=d),null!==i&&(t+="\n")}}else if("br"===r)null!==i&&"div"===p(i)||(t+="\n");else if("a"===r)t+=e.innerText;else if("span"===r){var s;for(a=(s=e.childNodes).length,c=0;c<a;c++)t+=b(s[c],!1)}}else m(e)&&(t+=e.textContent);return t};e.getValue=function(){return b(n,!0)},e.setValue=function(t){t!==e.getValue()&&(n.innerText=t,i(100),h())},e.setVisibility=function(n){e.setAttribute("data-form-element-visibility",n?"1":"0")},e.isActive=function(){var e=document.activeElement;return n===e||n.contains(e)}}}(elements[i]);
EOT;
