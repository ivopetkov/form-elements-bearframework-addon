<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='rich-textarea']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var n=e.querySelector("div"),t=-1!==["true"].indexOf(n.getAttribute("noLines")),r=n.getAttribute("autoHighlight");null===r&&(r=""),r=(r=r.trim()).length>0?(r=r.split(",")).map((function(e){return e.trim()})):[];var l=function(e){return-1!==r.indexOf("*")||-1!==r.indexOf(e)},a=function(e){for(var r=!1,l=n.querySelectorAll("*"),i=0;i<l.length;i++){var o=l[i],u=o.tagName.toLowerCase();if(t)if("br"===u){if(null!==o.nextSibling){var f=document.createElement("span");o.parentNode.replaceChild(f,o),r=!0}}else if("div"===u){(f=document.createElement("span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(f,o),o=f,r=!0}if(-1===["br","span","div","a"].indexOf(u))(f=document.createElement("block"===window.getComputedStyle(o).display?"div":"span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(f,o),o=f,r=!0;var d=o.attributes;if(d.length>0){for(var c=[],h=0;h<d.length;h++)c.push(d[h].name);for(h=0;h<c.length;h++){var s=c[h];"a"===u&&-1!==["data-rich-textarea-link-type"].indexOf(s)||(o.removeAttribute(s),r=!0)}}}r&&--e>0&&a(e)},i=function(){var e=window.getSelection();return"Caret"===e.type?{node:e.anchorNode,offset:e.anchorOffset}:null},o=function(e,n){try{var t=window.getSelection(),r=new Range;r.setStart(1===e.nodeType?e.firstChild:e,n),r.collapse(!0),t.removeAllRanges(),t.addRange(r)}catch(e){}},u=null,f=null,d=function(e){clientPackages.get("tooltip").then((function(n){f=n,function(){null===u&&(u=f.generateID());var n=e.getAttribute("data-rich-textarea-link-type"),t=e.innerText,r="";"url"===n?(-1===t.indexOf("//")&&(t="https://"+t),r='<a href="'+t+'" target="_blank" rel="noopener">Open URL</a>'):"email"===n?r='<a href="mailto:'+t+'" target="_blank" rel="noopener">Email</a>':"phone"===n&&(r='<a href="tel:'+t+'" target="_blank" rel="noopener">Call</a>'),0!==r.length&&f.show(u,e,r,{showArrow:!0,align:"center",contentSpacing:2,preferedPositions:["bottom","top","left","right"],onBeforeShow:function(e){e.setAttribute("data-form-element-component","highlight-tooltip")},onShow:function(e){}})}()}))},c=function(){null!==f&&null!==u&&f.hide(u)},h=function(){if(0!==r.length){var e=n.innerText,t=function(n){for(var t=[],r=null;r=n.exec(e);)t.push(r[0]);return t.sort((function(e,n){return n.length-e.length})),t=t.filter((function(e,n,t){return t.indexOf(e)===n}))},a=[];if(l("email"))for(var u=t(/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim),f=0;f<u.length;f++){var d=u[f];a.push([d,'<a data-rich-textarea-link-type="email">'+d+"</a>"])}if(l("url")){var c=t(/(\b((http|https):\/\/)?(www\.)?([a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+)(\/[a-zA-Z0-9-._~:/?#[\]@!$&'()*+,;%=]*)?)/gim);for(f=0;f<c.length;f++){var h=c[f];a.push([h,'<a data-rich-textarea-link-type="url">'+h+"</a>"])}}if(l("phone")){var s=t(/(?:\+\d{1,3}\s?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}/gim);for(f=0;f<s.length;f++){var v=s[f];a.push([v,'<a data-rich-textarea-link-type="phone">'+v+"</a>"])}}if(l("tag")){var g=t(/#[a-zA-Z0-9-]+/gim);for(f=0;f<g.length;f++){var m=g[f];a.push([m,'<a data-rich-textarea-link-type="tag">'+m+"</a>"])}}var b=function(e){for(var n=0;n<a.length;n++){var t=a[n];if(t[0]===e)return t[1]}return null},x=function(e,n){var t=null!==n?n.offset:null;if(e.length>0){var r=function(e){for(var n=0;n<a.length;n++)for(var t=a[n],l=0;l<e.length;l++){var i=e[l];if(i!==t[0]&&null===b(i)){var o=i.split(t[0]);if(o.length>1){for(var u=[],f=0;f<o.length;f++)f>0&&u.push(t[0]),u.push(o[f]);return r([].concat(e.slice(0,l),u,e.slice(l+1)).filter((function(e){return e.length>0})))}}}return e},l="",i=!1,o=0,u=null,f=null;if(null!==(v=b(e)))l=v,i=!0,o=1,null!==n&&(u=0,f=t);else{var d=r([e]);if((o=d.length)>1)for(var c=0,h=0,s=0;s<d.length;s++){var v,g=d[s];if(l+=null!==(v=b(g))?v:p(g),null!==n){var m=g.length;h+m>=t&&null===u&&(u=c,f=t-h),c++,h+=m}}}if(""!==l)return{html:l,match:i,nodesCount:o,caretNodeIndex:u,caretNodeOffset:f}}return null},y=function(e,n,t){var r=e.parentNode,l=e.previousSibling,a=e.nextSibling,i=document.createElement("span");if(r.insertBefore(i,e),i.insertAdjacentHTML("beforebegin",n.html),r.removeChild(i),null!==t&&(e===t.node||3===t.node.nodeType&&t.node.parentNode===e)){for(var u=e,f=0;f<n.nodesCount-n.caretNodeIndex;f++)u=u.previousSibling;o(u,n.caretNodeOffset)}return r.removeChild(e),null!==l&&T(l),null!==a&&T(a),!0},T=function(e){var n=!1;if(3===e.nodeType){var t=i(),r=null!==t?t.node:null,l=null!==t?t.offset:null,a=e.previousSibling,u=e.nextSibling;if(null!==u&&3===u.nodeType){var f=null;r===e?f=l:r===u&&(f=e.nodeValue.length+l),e.nodeValue+=u.nodeValue,e.parentNode.removeChild(u),null!==f&&o(e,f),n=!0}if(null!==a&&3===a.nodeType){f=null;r===a?f=l:r===e&&(f=a.nodeValue.length+l),a.nodeValue+=e.nodeValue,e.parentNode.removeChild(e),null!==f&&o(a,f),n=!0}}return n},w=i(),A=function(e){for(var n=!1,t=e.childNodes,r=[],l=0;l<t.length;l++)r.push(t[l]);for(l=0;l<r.length;l++){var a=!1,u=r[l];if(1===u.nodeType)if("a"===u.tagName.toLowerCase()){var f=u.innerText;if(null!==(c=x(f,w)))c.match||(y(u,c,w),n=!0,a=!0);else{var d=document.createTextNode(f);e.replaceChild(d,u),(w.node===u||3===w.node.nodeType&&w.node.parentNode===u)&&o(d,w.offset),T(d),n=!0,a=!0}}else A(u)&&(n=!0,a=!0);else if(3===u.nodeType){var c;null!==(c=x(u.textContent,w))&&(y(u,c,w),n=!0,a=!0)}a&&(w=i())}return n};for(f=0;f<100;f++){if(!A(n))break}}},s=new Map,p=function(e){var n=s.get(e);if(void 0!==n)return n;let t=document.createElement("div");t.innerText=e;var r=t.innerHTML;return s.set(e,r),r};n.getFormElementContainer=function(){return e};var v=!1;n.addEventListener("input",(function(){c(),a(100),h(),v=!0})),n.addEventListener("blur",(function(){v&&(n.dispatchEvent(new Event("change",{bubbles:!0})),v=!1)})),h(),n.addEventListener("click",()=>{var e=window.getSelection().anchorNode,t=3===e.nodeType?e.parentNode:e;n.contains(t)&&null!==t.getAttribute("data-rich-textarea-link-type")?d(t):c()}),e.getValue=function(){return n.innerText},e.setValue=function(e){e!==n.innerText&&(n.innerText=e,a(100),h())},e.setVisibility=function(n){e.setAttribute("data-form-element-visibility",n?"1":"0")}}}(elements[i]);
EOT;
