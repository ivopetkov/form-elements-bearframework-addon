<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='rich-textarea']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var n=e.querySelector("div"),t=-1!==["true"].indexOf(n.getAttribute("noLines")),r=n.getAttribute("autoHighlight");null===r&&(r=""),r=(r=r.trim()).length>0?(r=r.split(",")).map((function(e){return e.trim()})):[];var l=function(e){return-1!==r.indexOf("*")||-1!==r.indexOf(e)},a=function(e){for(var r=!1,l=n.querySelectorAll("*"),i=0;i<l.length;i++){var o=l[i],u=o.tagName.toLowerCase();if(t)if("br"===u){if(null!==o.nextSibling){var d=document.createElement("span");o.parentNode.replaceChild(d,o),r=!0}}else if("div"===u){(d=document.createElement("span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(d,o),o=d,r=!0}if(-1===["br","span","div","a"].indexOf(u))(d=document.createElement("block"===window.getComputedStyle(o).display?"div":"span")).innerHTML=o.innerHTML,o.parentNode.replaceChild(d,o),o=d,r=!0;var f=o.attributes;if(f.length>0){for(var c=[],h=0;h<f.length;h++)c.push(f[h].name);for(h=0;h<c.length;h++){var s=c[h];"a"===u&&-1!==["data-rich-textarea-link-type"].indexOf(s)||(o.removeAttribute(s),r=!0)}}}n.childNodes;if(1===n.childNodes.length){var v=n.firstChild;1===v.nodeType&&"br"===v.tagName.toLowerCase()&&(n.removeChild(v),r=!0)}r&&--e>0&&a(e)},i=function(){var e=window.getSelection();return"Caret"===e.type?{node:e.anchorNode,offset:e.anchorOffset}:null},o=function(e,n){try{var t=window.getSelection(),r=new Range;r.setStart(1===e.nodeType?e.firstChild:e,n),r.collapse(!0),t.removeAllRanges(),t.addRange(r)}catch(e){}},u=null,d=null,f=function(e){clientPackages.get("tooltip").then((function(n){d=n,function(){null===u&&(u=d.generateID());var n=e.getAttribute("data-rich-textarea-link-type"),t=e.innerText,r="";"url"===n?(-1===t.indexOf("//")&&(t="https://"+t),r='<a href="'+t+'" target="_blank" rel="noopener">Open URL</a>'):"email"===n?r='<a href="mailto:'+t+'" target="_blank" rel="noopener">Email</a>':"phone"===n&&(r='<a href="tel:'+t+'" target="_blank" rel="noopener">Call</a>'),0!==r.length&&d.show(u,e,r,{showArrow:!0,align:"center",contentSpacing:8,preferedPositions:["bottom","top","left","right"],onBeforeShow:function(e){e.setAttribute("data-form-element-component","highlight-tooltip")},onShow:function(e){}})}()}))},c=function(){null!==d&&null!==u&&d.hide(u)},h=function(){if(0!==r.length){var e=n.innerText,t=function(n){for(var t=[],r=null;r=n.exec(e);)t.push(r[0]);return t.sort((function(e,n){return n.length-e.length})),t=t.filter((function(e,n,t){return t.indexOf(e)===n}))},a=[];if(l("email"))for(var u=t(/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim),d=0;d<u.length;d++){var f=u[d];a.push([f,'<a data-rich-textarea-link-type="email">'+f+"</a>"])}if(l("url")){var c=t(/(\b((http|https):\/\/)?(www\.)?([a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+)(\/[a-zA-Z0-9-._~:/?#[\]@!$&'()*+,;%=]*)?)/gim);for(d=0;d<c.length;d++){var h=c[d];a.push([h,'<a data-rich-textarea-link-type="url">'+h+"</a>"])}}if(l("phone")){var s=t(/(?:\+\d{1,3}\s?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}/gim);for(d=0;d<s.length;d++){var g=s[d];a.push([g,'<a data-rich-textarea-link-type="phone">'+g+"</a>"])}}if(l("tag")){var p=t(/#[a-zA-Z0-9-]+/gim);for(d=0;d<p.length;d++){var m=p[d];a.push([m,'<a data-rich-textarea-link-type="tag">'+m+"</a>"])}}var b=function(e){for(var n=0;n<a.length;n++){var t=a[n];if(t[0]===e)return t[1]}return null},x=function(e,n){var t=null!==n?n.offset:null;if(e.length>0){var r=function(e){for(var n=0;n<a.length;n++)for(var t=a[n],l=0;l<e.length;l++){var i=e[l];if(i!==t[0]&&null===b(i)){var o=i.split(t[0]);if(o.length>1){for(var u=[],d=0;d<o.length;d++)d>0&&u.push(t[0]),u.push(o[d]);return r([].concat(e.slice(0,l),u,e.slice(l+1)).filter((function(e){return e.length>0})))}}}return e},l="",i=!1,o=0,u=null,d=null;if(null!==(g=b(e)))l=g,i=!0,o=1,null!==n&&(u=0,d=t);else{var f=r([e]);if((o=f.length)>1)for(var c=0,h=0,s=0;s<f.length;s++){var g,p=f[s];if(l+=null!==(g=b(p))?g:v(p),null!==n){var m=p.length;h+m>=t&&null===u&&(u=c,d=t-h),c++,h+=m}}}if(""!==l)return{html:l,match:i,nodesCount:o,caretNodeIndex:u,caretNodeOffset:d}}return null},y=function(e,n,t){var r=e.parentNode,l=e.previousSibling,a=e.nextSibling,i=document.createElement("span");if(r.insertBefore(i,e),i.insertAdjacentHTML("beforebegin",n.html),r.removeChild(i),null!==t&&(e===t.node||3===t.node.nodeType&&t.node.parentNode===e)){for(var u=e,d=0;d<n.nodesCount-n.caretNodeIndex;d++)u=u.previousSibling;o(u,n.caretNodeOffset)}return r.removeChild(e),null!==l&&T(l),null!==a&&T(a),!0},T=function(e){var n=!1;if(3===e.nodeType){var t=i(),r=null!==t?t.node:null,l=null!==t?t.offset:null,a=e.previousSibling,u=e.nextSibling;if(null!==u&&3===u.nodeType){var d=null;r===e?d=l:r===u&&(d=e.nodeValue.length+l),e.nodeValue+=u.nodeValue,e.parentNode.removeChild(u),null!==d&&o(e,d),n=!0}if(null!==a&&3===a.nodeType){d=null;r===a?d=l:r===e&&(d=a.nodeValue.length+l),a.nodeValue+=e.nodeValue,e.parentNode.removeChild(e),null!==d&&o(a,d),n=!0}}return n},C=i(),N=function(e){for(var n=!1,t=e.childNodes,r=[],l=0;l<t.length;l++)r.push(t[l]);for(l=0;l<r.length;l++){var a=!1,u=r[l];if(1===u.nodeType)if("a"===u.tagName.toLowerCase()){var d=u.innerText;if(null!==(c=x(d,C)))c.match||(y(u,c,C),n=!0,a=!0);else{var f=document.createTextNode(d);e.replaceChild(f,u),(C.node===u||3===C.node.nodeType&&C.node.parentNode===u)&&o(f,C.offset),T(f),n=!0,a=!0}}else N(u)&&(n=!0,a=!0);else if(3===u.nodeType){var c;null!==(c=x(u.textContent,C))&&(y(u,c,C),n=!0,a=!0)}a&&(C=i())}return n};for(d=0;d<100;d++){if(!N(n))break}}},s=new Map,v=function(e){var n=s.get(e);if(void 0!==n)return n;let t=document.createElement("div");t.innerText=e;var r=t.innerHTML;return s.set(e,r),r};n.getFormElementContainer=function(){return e};var g=!1;n.addEventListener("input",(function(){c(),a(100),h(),g=!0})),n.addEventListener("blur",(function(){g&&(n.dispatchEvent(new Event("change",{bubbles:!0})),g=!1)})),h(),n.addEventListener("click",()=>{var e=window.getSelection().anchorNode,t=3===e.nodeType?e.parentNode:e;n.contains(t)&&null!==t.getAttribute("data-rich-textarea-link-type")?f(t):c()}),e.getValue=function(){if(null!==n.querySelector("div")){for(var e="",t=n.childNodes,r=0;r<t.length;r++){var l=t[r];if(1===l.nodeType){var a=l.tagName.toLowerCase();if("div"===a){var i=l.childNodes.length,o=l.firstChild,u=null!==o?o.nextSibling:null,d=l.lastChild;if(0===i);else{var f=!1;1===i&&1===o.nodeType&&"br"===o.tagName.toLowerCase()||2===i&&1===o.nodeType&&"br"===o.tagName.toLowerCase()&&3===u.nodeType&&"\n"===u.textContent?f=!0:null!==o&&null!==l.previousSibling&&(e+="\n");var c=l.innerText;f||null===d||1!==d.nodeType||"br"!==d.tagName.toLowerCase()||(c=c.substring(0,c.length-1)),e+=c}}else e+="br"===a?"\n":l.innerText}else e+=l.textContent}return e}return n.innerText},e.setValue=function(t){t!==e.getValue()&&(n.innerText=t,a(100),h())},e.setVisibility=function(n){e.setAttribute("data-form-element-visibility",n?"1":"0")},e.isActive=function(){var e=document.activeElement;return n===e||n.contains(e)}}}(elements[i]);
EOT;
