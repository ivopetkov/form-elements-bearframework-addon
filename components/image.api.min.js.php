<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='image']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("[data-form-element-component='clear-button']"),n=e.querySelector("[data-form-element-component='text']"),r=n.parentNode,l=e.querySelector("input"),a=l.getAttribute("data-form-element-data-max-size");""===a?a=null:null!==a&&(a=parseInt(a)),l.getFormElementContainer=function(){return e};var i=[],o=function(e){for(var t=0;t<i.length;t++){var n=i[t];if(n[0]===e)return n[1]}return null};e.getValue=function(){var e=l.files,t=e.length;if(0===t)return l.getAttribute("data-value");for(var n=[],r=0;r<t;r++){var a=e[r],i=o(a);null!==i?n.push(i):n.push({value:a.name,filename:null,size:a.size,type:a.type})}return JSON.stringify(n)},e.setValue=function(e){if(""!==e)throw new Error("Only empty string allowed!");l.value="",l.setAttribute("data-value",""),l.dispatchEvent(new Event("change"))},e.hasPendingUploads=function(){for(var e=l.files,t=e.length,n=0;n<t;n++){if(!o(e[n]))return!0}return!1},e.upload=function(e,t,n,r,u){for(var s=l.files,f=s.length,m=0,d=[],v=0;v<f;v++){var c=s[v];if(null!==a&&c.size>a)return void r(ivoPetkovBearFrameworkAddonsFormElementsImageGetText("ivopetkov.form-element.image.TooBig").replace("%s",ivoPetkovBearFrameworkAddonsFormElementsImageFormatBytes(a)));null===o(c)?(d[v]=0,m++):d[v]=100}var g=function(l){if(void 0!==s[l]){var a=s[l];null===o(a)&&e(a,(function(e){g(l+1),m--,i.push([a,e]),0===m&&t()}),(function(){void 0!==n&&n()}),(function(){void 0!==r&&r()}),(function(e){d[l]=e,function(){if(void 0!==u){for(var e=0,t=0;t<f;t++)e+=d[t];u(e/f)}}()}))}};g(0)},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")},null!==t&&t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault(),e.setValue("")}),!1);var u=function(){if(0===l.files.length)n.innerText=0===e.getValue().length?"CHOOSE_TEXT_TO_REPLACE":"",null!==t&&(t.style.display="none"),r.style.backgroundImage="";else{n.innerText="",null!==t&&(t.style.display="inline-block");var a=new FileReader;a.addEventListener("load",(function(){r.style.backgroundImage="url("+a.result+")"}),!1),a.readAsDataURL(l.files[0])}};l.addEventListener("change",(function(){u(),setTimeout(u,1)}),!1)}}(elements[i]);
EOT;
