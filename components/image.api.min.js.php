<?php

/*
 * Form elements addon for Bear Framework
 * https://github.com/ivopetkov/form-elements-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
for(var elements=document.body.querySelectorAll("[data-form-element-type='image']"),i=0;i<elements.length;i++)!function(e){if(void 0===e.dataFormElementAPISet){e.dataFormElementAPISet=!0;var t=e.querySelector("[data-form-element-component='clear-button']"),n=e.querySelector("[data-form-element-component='text']"),r=n.parentNode,a=e.querySelector("input"),l=e.querySelectorAll("label"),i=l[l.length-1],o=a.getAttribute("data-form-element-data-max-size");""===o?o=null:null!==o&&(o=parseInt(o));var u=null,s=function(){return null!==u?u:a.files};a.getFormElementContainer=function(){return e},i.getFormElementContainer=function(){return e};var d=function(e){e.preventDefault(),e.stopPropagation(),i.setAttribute("data-form-element-event","drag-over")},v=function(e){e.preventDefault(),e.stopPropagation(),i.removeAttribute("data-form-element-event")};i.addEventListener("dragenter",d,!1),i.addEventListener("dragover",d,!1),i.addEventListener("dragleave",v,!1),i.addEventListener("drop",(function(e){v(e),u=e.dataTransfer.files,g=!1,a.dispatchEvent(new Event("change",{bubbles:!0})),g=!0}),!1);var f=[],m=function(e){for(var t=0;t<f.length;t++){var n=f[t];if(n[0]===e)return n[1]}return null};e.getName=function(){return a.getAttribute("name")},e.getValue=function(){var e=s(),t=e.length;if(0===t)return a.getAttribute("data-value");for(var n=[],r=0;r<t;r++){var l=e[r],i=m(l);null!==i?n.push(i):n.push({value:l.name,filename:null,size:l.size,type:l.type})}return JSON.stringify(n)},e.setValue=function(e){if(null!==e&&""!==e)throw new Error("Only empty string allowed!");u=null,a.value="",a.setAttribute("data-value",""),a.dispatchEvent(new Event("change",{bubbles:!0}))},e.hasValue=function(){return""!==e.getValue()},e.getUploadDetails=function(e){for(var t=s(),n=t.length,r=0;r<n;r++){var a=t[r];if(m(a)===e)return{name:a.name,size:a.size,type:a.type}}return null},e.hasPendingUploads=function(){for(var e=s(),t=e.length,n=0;n<t;n++){if(!m(e[n]))return!0}return!1},e.upload=function(e,t,n,r,a){for(var l=s(),i=l.length,u=0,d=[],v=0;v<i;v++){var c=l[v];if(null!==o&&c.size>o)return void r(ivoPetkovBearFrameworkAddonsFormElementsImageGetText("ivopetkov.form-element.image.TooBig").replace("%s",ivoPetkovBearFrameworkAddonsFormElementsImageFormatBytes(o)));null===m(c)?(d[v]=0,u++):d[v]=100}var g=function(o){if(void 0!==l[o]){var s=l[o];null===m(s)&&e(s,(function(e){g(o+1),u--,f.push([s,e]),0===u&&t()}),(function(e){void 0!==n&&n(e)}),(function(e){void 0!==r&&r(e)}),(function(e){d[o]=e,function(){if(void 0!==a){for(var e=0,t=0;t<i;t++)e+=d[t];a(e/i)}}()}))}};g(0)},e.setVisibility=function(t){e.setAttribute("data-form-element-visibility",t?"1":"0")},null!==t&&t.addEventListener("click",(function(t){t.stopPropagation(),t.preventDefault(),e.setValue("")}),!1);var c=function(){var a=s();if(0===a.length)n.innerText=0===e.getValue().length?"CHOOSE_TEXT_TO_REPLACE":"",null!==t&&(t.style.display="none"),r.style.backgroundImage="";else{n.innerText="",null!==t&&(t.style.display="inline-block");var l=new FileReader;l.addEventListener("load",(function(){r.style.backgroundImage="url("+l.result+")"}),!1),l.readAsDataURL(a[0])}},g=!0;a.addEventListener("change",(function(){g&&(u=null),c(),e.hasValue()?a.setAttribute("data-has-value","true"):a.removeAttribute("data-has-value"),setTimeout(c,1)}),!1)}}(elements[i]);
EOT;
